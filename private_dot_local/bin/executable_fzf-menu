#!/bin/sh
# fzfmenu - fzf as dmenu replacement

error() {
	echo >&2 "$*"
	exit 1
}

script_name=$(basename -- "$0")

if pidof -x "$script_name" -o $$ > /dev/null; then
	error "Another instance of this script is already running."
fi

# fifos are here to not wait for end of input
# (useful for e.g. find $HOME | fzfmenu ...)
input=$(mktemp -u --suffix .fzfmenu.input)
output=$(mktemp -u --suffix .fzfmenu.output)
mkfifo "$input"
mkfifo "$output"
chmod 600 "$input" "$output"

# the ugly printf | sed thing is here to make args with quotes work.
# (e.g. --preview='echo {1}').
# sadly we can't use "$@" here directly because we are inside sh -c "..." call
# already.
# you can also set window dimensions via -g '=COLSxROWS', see man st.
term-popup -T "menu" sh -c "cat $input | fzf --height 100% $(printf -- " '%s'" "$@" | sed "s/^ ''$//") | tee $output" &

# handle ctrl+c outside child terminal window
trap 'kill $! 2>/dev/null; rm -f $input $output' EXIT

cat > "$input"
cat "$output"
